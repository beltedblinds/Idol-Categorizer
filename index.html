<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Idol Categorizer</title>
<style>
  body {
    background: #111;
    color: #eee;
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0;
    padding: 0;
  }
  h1 {
    margin: 1em 0;
  }
  #image-container {
    margin: 1em auto;
    width: 80%;
    max-width: 600px;
  }
  img {
    width: 100%;
    border-radius: 12px;
    box-shadow: 0 0 10px rgba(255,255,255,0.2);
  }
  .buttons {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    margin: 1em 0;
  }
  button {
    margin: 0.5em;
    padding: 0.7em 1.2em;
    border: none;
    border-radius: 8px;
    font-size: 1em;
    cursor: pointer;
    background-color: #444;
    color: #eee;
    transition: background-color 0.3s;
  }
  button:hover {
    background-color: #666;
  }
  #status {
    margin-top: 1em;
    font-size: 0.9em;
    color: #9f9;
  }
</style>
</head>
<body>
  <h1>Idol Categorizer</h1>
  <div id="image-container">
    <img id="idol-image" src="" alt="Idol Image" />
  </div>

  <div class="buttons">
    <button id="previous-btn">Previous</button>
    <button id="skip-btn">Skip</button>
    <button id="uncategorized-toggle">Show Uncategorized Only</button>
  </div>

  <div class="buttons" id="category-buttons">
    <button class="category-btn" data-category="Group">Group</button>
    <button class="category-btn" data-category="Solo">Solo</button>
    <button class="category-btn" data-category="Subunit">Subunit</button>
  </div>

  <div class="buttons">
    <button id="save-btn">üíæ Save Categorized File</button>
  </div>

  <div id="status"></div>

<script>
const imageEl = document.getElementById('idol-image');
const statusEl = document.getElementById('status');
const uncategorizedToggle = document.getElementById('uncategorized-toggle');
let idolData = [];
let currentIndex = 0;
let showUncategorizedOnly = false;

// 1Ô∏è‚É£ Load idol_gallery_links.txt from idols-media-01
async function loadLinks() {
  const mediaResp = await fetch('https://raw.githubusercontent.com/beltedblinds/idols-media-01/main/idol_gallery_links.txt');
  const mediaText = await mediaResp.text();
  const mediaLines = mediaText.trim().split('\n').map(l => l.split(','));

  // 2Ô∏è‚É£ Load Idol-Categorizer's own copy if it exists
  let categorizedMap = {};
  try {
    const catResp = await fetch('https://raw.githubusercontent.com/beltedblinds/Idol-Categorizer/main/idol_gallery_links.txt');
    const catText = await catResp.text();
    catText.trim().split('\n').forEach(line => {
      const parts = line.split(',');
      const key = parts.slice(0, 3).join(',');
      categorizedMap[key] = parts[3] || '';
    });
  } catch (err) {
    console.log('No categorized file yet, starting fresh');
  }

  // 3Ô∏è‚É£ Merge new images from idols-media-01
  idolData = mediaLines.map(parts => {
    const key = parts.slice(0, 3).join(',');
    return { name: parts[0], url: parts[1], thumb: parts[2], category: categorizedMap[key] || '' };
  });

  showImage();
}

function showImage() {
  let filtered = idolData;
  if (showUncategorizedOnly) filtered = idolData.filter(i => !i.category);
  if (filtered.length === 0) {
    statusEl.textContent = "üéâ Categorization complete!";
    imageEl.src = '';
    return;
  }
  if (currentIndex >= filtered.length) currentIndex = 0;
  const idol = filtered[currentIndex];
  imageEl.src = idol.thumb || idol.url;
  statusEl.textContent = `${idol.name} (${idol.category || 'Uncategorized'})`;
}

document.getElementById('previous-btn').addEventListener('click', () => {
  currentIndex = Math.max(0, currentIndex - 1);
  showImage();
});

document.getElementById('skip-btn').addEventListener('click', () => {
  currentIndex++;
  showImage();
});

document.querySelectorAll('.category-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    let filtered = idolData;
    if (showUncategorizedOnly) filtered = idolData.filter(i => !i.category);
    if (filtered.length === 0) return;
    const idol = filtered[currentIndex];
    idol.category = btn.dataset.category;
    currentIndex++;
    showImage();
  });
});

uncategorizedToggle.addEventListener('click', () => {
  showUncategorizedOnly = !showUncategorizedOnly;
  uncategorizedToggle.textContent = showUncategorizedOnly ? 'Showing Uncategorized Only' : 'Show Uncategorized Only';
  currentIndex = 0;
  showImage();
});

// 4Ô∏è‚É£ Save to Idol-Categorizer repo
document.getElementById('save-btn').addEventListener('click', async () => {
  const updatedLinks = idolData.map(i => [i.name, i.url, i.thumb, i.category].join(',')).join('\n');
  statusEl.textContent = 'Saving...';

  const resp = await fetch('https://api.github.com/repos/beltedblinds/Idol-Categorizer/dispatches', {
    method: 'POST',
    headers: {
      'Accept': 'application/vnd.github+json',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      event_type: 'save_categorized',
      client_payload: { updated_file: updatedLinks }
    })
  });

  if (resp.ok) {
    statusEl.textContent = '‚úÖ Save event sent ‚Äî check Actions tab!';
  } else {
    statusEl.textContent = '‚ùå Save failed ‚Äî check workflow logs.';
  }
});

loadLinks();
</script>
</body>
</html>
