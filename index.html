<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ðŸŽ¶ Idol Categorizer</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #fff; text-align: center; }
    img { max-width: 400px; border-radius: 10px; margin: 20px; }
    button { margin: 5px; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; }
    .category-btn { background: #333; color: #fff; }
    .category-btn:hover { background: #555; }
    .control-btn { background: #0066ff; color: white; }
    #saveStatus { margin-top: 15px; font-size: 0.9rem; }
  </style>
</head>
<body>
  <h1>ðŸŽ¶ Idol Categorizer</h1>
  <p id="progress"></p>
  <img id="idolImage" src="" alt="Idol image">
  <div id="categoryButtons"></div>

  <div>
    <button class="control-btn" onclick="previousImage()">Previous</button>
    <button class="control-btn" onclick="skipImage()">Skip</button>
    <button class="control-btn" onclick="toggleUncategorized()">Show Uncat Only</button>
    <button class="control-btn" onclick="saveProgress()">Save Progress</button>
  </div>
  <p id="saveStatus"></p>

  <script>
    let allLines = [];
    let categorized = {};
    let currentIndex = 0;
    let showUncatOnly = false;
    let categories = [];
    let filtered = [];

    async function loadData() {
      const [mainTxt, catTxt, catList] = await Promise.all([
        fetch("https://raw.githubusercontent.com/beltedblinds/idols-media-01/main/idol_gallery_links.txt").then(r => r.text()),
        fetch("idol_gallery_links.txt").then(r => r.ok ? r.text() : ""),
        fetch("categories.txt").then(r => r.text())
      ]);

      categories = catList.split("\n").map(c => c.trim()).filter(Boolean);
      allLines = mainTxt.split("\n").filter(Boolean).map(l => l.split(",").map(x => x.trim()));

      if (catTxt) {
        catTxt.split("\n").forEach(line => {
          const parts = line.split(",").map(x => x.trim());
          if (parts.length >= 4) categorized[parts[1]] = parts[3];
        });
      }

      refreshFiltered();
      setupCategoryButtons();
      showImage();
    }

    function refreshFiltered() {
      filtered = allLines.filter(l => {
        const raw = l[1];
        if (showUncatOnly) return !categorized[raw];
        return true;
      });
    }

    function setupCategoryButtons() {
      const container = document.getElementById("categoryButtons");
      container.innerHTML = "";
      categories.forEach(cat => {
        const b = document.createElement("button");
        b.textContent = cat;
        b.className = "category-btn";
        b.onclick = () => assignCategory(cat);
        container.appendChild(b);
      });
    }

    function showImage() {
      if (filtered.length === 0) {
        document.getElementById("idolImage").src = "";
        document.getElementById("progress").textContent = "ðŸŽ‰ All categorized!";
        return;
      }

      const [name, raw, thumb] = filtered[currentIndex];
      document.getElementById("idolImage").src = raw;
      document.getElementById("progress").textContent =
        `${currentIndex + 1}/${filtered.length} â€” ${name}`;
    }

    function assignCategory(cat) {
      const [name, raw, thumb] = filtered[currentIndex];
      categorized[raw] = cat;
      nextImage();
    }

    function skipImage() {
      nextImage();
    }

    function previousImage() {
      if (currentIndex > 0) currentIndex--;
      showImage();
    }

    function nextImage() {
      currentIndex++;
      if (currentIndex >= filtered.length) {
        currentIndex = filtered.length - 1;
        document.getElementById("progress").textContent = "ðŸŽ‰ Categorization complete!";
      }
      showImage();
    }

    function toggleUncategorized() {
      showUncatOnly = !showUncatOnly;
      refreshFiltered();
      currentIndex = 0;
      showImage();
    }

    async function saveProgress() {
      const out = allLines.map(l => {
        const raw = l[1];
        const cat = categorized[raw] || "";
        return [...l.slice(0, 3), cat].join(", ");
      }).join("\n");

      const blob = new Blob([out], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "idol_gallery_links.txt";
      link.click();
      URL.revokeObjectURL(link.href);

      document.getElementById("saveStatus").textContent =
        "âœ… Saved locally â€” upload this file to your Idol-Categorizer repo.";
    }

    loadData();
  </script>
</body>
</html>
