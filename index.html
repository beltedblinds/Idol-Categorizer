<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Idol Categorizer</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    background: #111;
    color: #eee;
    margin: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
  }
  img {
    max-width: 80vw;
    max-height: 60vh;
    border-radius: 1rem;
    box-shadow: 0 0 20px #0008;
    margin: 1rem 0;
  }
  .controls {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    justify-content: center;
  }
  button {
    font-size: 1.1rem;
    padding: 0.5rem 1.25rem;
    border-radius: 0.5rem;
    border: none;
    background: #444;
    color: white;
    cursor: pointer;
    transition: background 0.2s;
  }
  button:hover { background: #666; }
  #progress {
    margin-top: 1rem;
    font-size: 0.9rem;
    opacity: 0.8;
  }
  #status {
    margin-top: 0.5rem;
    font-size: 0.9rem;
  }
  #download {
    margin-top: 1rem;
    background: #28a745;
    display: none;
  }
</style>
</head>
<body>
  <h1>üé∂ Idol Categorizer</h1>
  <div id="imageContainer"><p>Loading images...</p></div>

  <div class="controls" id="categoryButtons" style="display:none;"></div>

  <div class="controls" id="navButtons" style="display:none;">
    <button id="prev">‚¨ÖÔ∏è Previous</button>
    <button id="skip">‚è≠Ô∏è Skip</button>
    <button id="save">üíæ Save Progress</button>
    <button id="commit">üöÄ Commit to Repo</button>
  </div>

  <div id="progress"></div>
  <div id="status"></div>

<script>
const rawUrl = "https://raw.githubusercontent.com/beltedblinds/idols-media-01/main/idol_gallery_links.txt";
const categoriesUrl = "https://raw.githubusercontent.com/beltedblinds/Idol-Categorizer/main/categories.txt";
let lines = [];
let currentIndex = 0;

async function init() {
  const [linksRes, catRes] = await Promise.all([fetch(rawUrl), fetch(categoriesUrl)]);
  const linksText = await linksRes.text();
  const catText = await catRes.text();

  lines = linksText.split(/\r?\n/).filter(l => l.trim().length);
  const categories = catText.split(/\r?\n/).map(c => c.trim()).filter(Boolean);

  const catContainer = document.getElementById("categoryButtons");
  catContainer.innerHTML = categories.map(cat => `<button data-cat="${cat}">${cat}</button>`).join("");
  catContainer.style.display = "flex";

  document.querySelectorAll("button[data-cat]").forEach(btn =>
    btn.addEventListener("click", () => handleCategory(btn.dataset.cat))
  );

  document.getElementById("skip").addEventListener("click", nextImage);
  document.getElementById("prev").addEventListener("click", prevImage);
  document.getElementById("save").addEventListener("click", saveProgress);
  document.getElementById("commit").addEventListener("click", commitToRepo);

  loadProgress();
  showCurrent();
  document.getElementById("navButtons").style.display = "flex";
}

function showCurrent() {
  if (currentIndex < 0) currentIndex = 0;
  if (currentIndex >= lines.length) {
    document.getElementById("imageContainer").innerHTML = "<p>‚úÖ Categorization complete!</p>";
    document.getElementById("categoryButtons").style.display = "none";
    document.getElementById("navButtons").style.display = "flex";
    return;
  }

  const parts = lines[currentIndex].split(",").map(x => x.trim());
  const name = parts[0];
  const raw = parts[1];
  const thumb = parts[2];
  const category = parts[3] || "";

  document.getElementById("imageContainer").innerHTML = `
    <h3>${name}</h3>
    <img src="${raw}" alt="${name}" onerror="this.src='${thumb}'">
    <p>${category ? `Current category: <strong>${category}</strong>` : `<em>Uncategorized</em>`}</p>
  `;
  document.getElementById("progress").textContent = `Image ${currentIndex + 1} of ${lines.length}`;
}

function handleCategory(cat) {
  const parts = lines[currentIndex].split(",").map(x => x.trim());
  while (parts.length < 4) parts.push("");
  parts[3] = cat;
  lines[currentIndex] = parts.join(", ");
  saveProgress(false);
  nextImage();
}

function nextImage() {
  do {
    currentIndex++;
  } while (currentIndex < lines.length && lines[currentIndex].split(",").filter(Boolean).length >= 4);
  showCurrent();
}

function prevImage() {
  if (currentIndex > 0) {
    currentIndex--;
    showCurrent();
  }
}

function saveProgress(showMsg = true) {
  localStorage.setItem("categorizedProgress", JSON.stringify({ lines, currentIndex }));
  if (showMsg) {
    const status = document.getElementById("status");
    status.textContent = "üíæ Progress saved locally!";
    status.style.color = "#0f0";
    setTimeout(() => status.textContent = "", 2000);
  }
}

function loadProgress() {
  const saved = JSON.parse(localStorage.getItem("categorizedProgress") || "{}");
  if (saved.lines && saved.lines.length === lines.length) {
    lines = saved.lines;
    currentIndex = saved.currentIndex || 0;
  }
}

async function commitToRepo() {
  saveProgress(false);
  const updated = lines.join("\n");
  const status = document.getElementById("status");
  status.textContent = "‚è≥ Committing to repo...";
  status.style.color = "#ffa500";

  const response = await fetch(
    "https://api.github.com/repos/beltedblinds/Idol-Categorizer/dispatches",
    {
      method: "POST",
      headers: {
        "Accept": "application/vnd.github+json",
        "Authorization": "Bearer GITHUB_TOKEN_PLACEHOLDER",
      },
      body: JSON.stringify({
        event_type: "update_links",
        client_payload: { updated_file: updated }
      })
    }
  );

  if (response.ok) {
    status.textContent = "‚úÖ Commit sent to idols-media-01!";
    status.style.color = "#0f0";
  } else {
    status.textContent = "‚ùå Commit failed ‚Äî check token or workflow logs.";
    status.style.color = "#f00";
  }

  setTimeout(() => status.textContent = "", 4000);
}

init();
</script>
</body>
</html>
