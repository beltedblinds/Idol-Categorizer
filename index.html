<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Idol Categorizer</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    background: #111;
    color: #eee;
    margin: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
  }
  h1 { margin-bottom: 0.5rem; }
  img {
    max-width: 80vw;
    max-height: 60vh;
    border-radius: 1rem;
    box-shadow: 0 0 20px #0008;
    margin: 1rem 0;
  }
  .controls {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.5rem;
  }
  button {
    font-size: 1.1rem;
    padding: 0.5rem 1.25rem;
    border-radius: 0.5rem;
    border: none;
    background: #444;
    color: white;
    cursor: pointer;
    transition: background 0.2s;
  }
  button:hover { background: #666; }
  #progress { margin-top: 0.75rem; font-size: 0.9rem; opacity: 0.8; }
  #saveStatus { margin-top: 0.5rem; font-size: 0.9rem; opacity: 0.7; }
  #bottomButtons {
    margin-top: 1.5rem;
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    justify-content: center;
  }
  .toggle-on { background: #007bff; }
</style>
</head>
<body>
  <h1>üé∂ Idol Categorizer</h1>
  <div id="imageContainer"><p>Loading images...</p></div>

  <div class="controls" id="categoryButtons" style="display:none;"></div>

  <div id="progress"></div>
  <div id="saveStatus"></div>

  <div id="bottomButtons">
    <button id="prevBtn">Previous</button>
    <button id="skipBtn">Skip</button>
    <button id="toggleUncat">Show Uncategorised Only: OFF</button>
    <button id="saveBtn">Save Progress</button>
  </div>

<script>
const srcRaw = "https://raw.githubusercontent.com/beltedblinds/idols-media-01/main/idol_gallery_links.txt";
const catRaw = "https://raw.githubusercontent.com/beltedblinds/Idol-Categorizer/main/idol_gallery_links.txt";
const catsFile = "https://raw.githubusercontent.com/beltedblinds/Idol-Categorizer/main/categories.txt";

let categories = [];
let mergedLines = [];
let currentIndex = 0;
let uncategorizedOnly = false;

// Load categories, source, and local categorized data
async function init() {
  try {
    const [catText, srcText, localText] = await Promise.all([
      fetch(catsFile).then(r => r.ok ? r.text() : ""),
      fetch(srcRaw).then(r => r.text()),
      fetch(catRaw).then(r => r.ok ? r.text() : "")
    ]);

    categories = catText.split(/\r?\n/).filter(Boolean);
    renderCategoryButtons();

    const srcLines = srcText.split(/\r?\n/).filter(l => l.trim());
    const localLines = localText.split(/\r?\n/).filter(l => l.trim());

    const localMap = new Map();
    for (const l of localLines) {
      const parts = l.split(",").map(x => x.trim());
      if (parts.length >= 3) localMap.set(parts[1], parts[3] || "");
    }

    mergedLines = srcLines.map(line => {
      const parts = line.split(",").map(x => x.trim());
      const cat = localMap.get(parts[1]) || "";
      return [parts[0], parts[1], parts[2], cat];
    });

    if (!mergedLines.length) {
      document.getElementById("imageContainer").innerHTML = "<p>No images found.</p>";
      return;
    }

    showCurrent();
  } catch (e) {
    document.getElementById("imageContainer").innerHTML = "<p>‚ö†Ô∏è Failed to load data</p>";
    console.error(e);
  }
}

function renderCategoryButtons() {
  const div = document.getElementById("categoryButtons");
  div.innerHTML = "";
  categories.forEach(cat => {
    const btn = document.createElement("button");
    btn.textContent = cat;
    btn.onclick = () => handleCategory(cat);
    div.appendChild(btn);
  });
  div.style.display = "flex";
}

function showCurrent() {
  const filtered = getFilteredList();
  if (!filtered.length) {
    document.getElementById("imageContainer").innerHTML = "<p>‚úÖ Categorization complete!</p>";
    document.getElementById("categoryButtons").style.display = "none";
    return;
  }
  const { idx, data } = filtered[currentIndex] || filtered[0];
  const [name, raw, thumb, cat] = data;

  document.getElementById("imageContainer").innerHTML = `
    <h3>${name}</h3>
    <img src="${raw}" alt="${name}" onerror="this.style.display='none';">
    <p>Category: <b>${cat || "(none)"}</b></p>
  `;
  document.getElementById("progress").textContent = 
    `Image ${currentIndex + 1} of ${filtered.length}`;
}

function getFilteredList() {
  return mergedLines
    .map((data, idx) => ({ idx, data }))
    .filter(obj => !uncategorizedOnly || !obj.data[3]);
}

function handleCategory(cat) {
  const filtered = getFilteredList();
  if (!filtered.length) return;

  const { idx } = filtered[currentIndex];
  mergedLines[idx][3] = cat;

  if (currentIndex < filtered.length - 1) {
    currentIndex++;
  }
  showCurrent();
}

function skipImage() {
  const filtered = getFilteredList();
  if (currentIndex < filtered.length - 1) currentIndex++;
  showCurrent();
}

function prevImage() {
  if (currentIndex > 0) currentIndex--;
  showCurrent();
}

async function saveProgress() {
  const updated = mergedLines.map(x => x.join(", ")).join("\n");
  document.getElementById("saveStatus").textContent = "üíæ Saving...";

  const response = await fetch("https://api.github.com/repos/beltedblinds/Idol-Categorizer/dispatches", {
    method: "POST",
    headers: {
      "Accept": "application/vnd.github+json",
      "Authorization": "Bearer GITHUB_TOKEN_PLACEHOLDER", // Replace manually for local testing if needed
    },
    body: JSON.stringify({
      event_type: "save_categorized_links",
      client_payload: { updated_file: updated }
    })
  });

  if (response.ok) {
    document.getElementById("saveStatus").textContent = "‚úÖ Saved and committed!";
  } else {
    document.getElementById("saveStatus").textContent = "‚ùå Save failed ‚Äî check token or workflow logs.";
  }
}

function toggleUncat() {
  uncategorizedOnly = !uncategorizedOnly;
  document.getElementById("toggleUncat").textContent = 
    `Show Uncategorised Only: ${uncategorizedOnly ? "ON" : "OFF"}`;
  currentIndex = 0;
  showCurrent();
}

// Event bindings
document.getElementById("skipBtn").onclick = skipImage;
document.getElementById("prevBtn").onclick = prevImage;
document.getElementById("saveBtn").onclick = saveProgress;
document.getElementById("toggleUncat").onclick = toggleUncat;

init();
</script>
</body>
</html>
