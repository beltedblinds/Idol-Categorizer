<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>🎶 Idol Categorizer</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    background: #111;
    color: #eee;
    text-align: center;
    margin: 0;
    padding: 0;
  }
  h1 { margin: 20px 0; }
  img {
    max-width: 80%;
    height: auto;
    border-radius: 10px;
    margin-top: 20px;
  }
  .buttons {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 20px;
    gap: 10px;
  }
  button {
    background: #333;
    border: none;
    color: white;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
  }
  button:hover {
    background: #555;
  }
  #status {
    margin-top: 15px;
    font-size: 14px;
  }
</style>
</head>
<body>
<h1>🎶 Idol Categorizer</h1>
<p id="status">Loading idol data...</p>
<img id="idolImage" src="" alt="Idol" hidden />

<div class="buttons" id="categoryButtons"></div>

<div class="buttons">
  <button id="skipButton">⏭ Skip</button>
  <button id="prevButton">⬅ Previous</button>
  <button id="saveButton">💾 Save Categorized File</button>
</div>

<script>
const idolsMediaRepo = "https://raw.githubusercontent.com/beltedblinds/idols-media-01/main/idol_gallery_links.txt";
const categorizerRepo = "https://raw.githubusercontent.com/beltedblinds/Idol-Categorizer/main/idol_gallery_links.txt";
const repoOwner = "beltedblinds";
const repoName = "Idol-Categorizer";

let idolData = [];
let currentIndex = 0;
let categories = [];
let categorizedData = [];

// ✅ Fetch categories from local file
async function loadCategories() {
  const res = await fetch("categories.txt");
  const text = await res.text();
  categories = text.split("\n").map(x => x.trim()).filter(Boolean);
  const container = document.getElementById("categoryButtons");
  container.innerHTML = "";
  categories.forEach(cat => {
    const btn = document.createElement("button");
    btn.textContent = cat;
    btn.onclick = () => categorize(cat);
    container.appendChild(btn);
  });
}

// ✅ Load both idol files and merge them
async function loadData() {
  document.getElementById("status").textContent = "Loading data...";
  const [mediaText, catText] = await Promise.all([
    fetch(idolsMediaRepo).then(r => r.text()).catch(() => ""),
    fetch(categorizerRepo).then(r => r.text()).catch(() => "")
  ]);

  const mediaLines = mediaText.split("\n").filter(x => x.trim());
  const catLines = catText.split("\n").filter(x => x.trim());
  const catMap = new Map(catLines.map(line => {
    const [name, raw, thumb, cat] = line.split(",").map(v => v.trim());
    return [raw, { name, raw, thumb, cat }];
  }));

  idolData = mediaLines.map(line => {
    const [name, raw, thumb] = line.split(",").map(v => v.trim());
    const existing = catMap.get(raw);
    return { name, raw, thumb, cat: existing ? existing.cat : "" };
  });

  categorizedData = idolData.map(x => ({ ...x }));
  document.getElementById("status").textContent = "Ready!";
  showImage();
}

// ✅ Display current image
function showImage() {
  const img = document.getElementById("idolImage");
  const status = document.getElementById("status");

  if (currentIndex >= idolData.length) {
    img.hidden = true;
    status.textContent = "🎉 Categorization complete!";
    return;
  }

  const item = idolData[currentIndex];
  img.src = item.raw;
  img.hidden = false;
  status.textContent = `${item.name} (${currentIndex + 1}/${idolData.length}) — Category: ${item.cat || "None"}`;
}

// ✅ Assign category
function categorize(cat) {
  idolData[currentIndex].cat = cat;
  categorizedData[currentIndex] = { ...idolData[currentIndex] };
  currentIndex++;
  showImage();
}

// ✅ Skip image
document.getElementById("skipButton").onclick = () => {
  currentIndex++;
  showImage();
};

// ✅ Previous image
document.getElementById("prevButton").onclick = () => {
  if (currentIndex > 0) currentIndex--;
  showImage();
};

// ✅ Save categorized file
document.getElementById("saveButton").onclick = async () => {
  const status = document.getElementById("status");
  status.textContent = "⏳ Saving...";
  const output = categorizedData.map(x => `${x.name}, ${x.raw}, ${x.thumb}, ${x.cat || ""}`).join("\n");

  const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/dispatches`, {
    method: "POST",
    headers: {
      "Accept": "application/vnd.github+json",
      "Authorization": `Bearer ${await getGithubToken()}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      event_type: "update_categorized_links",
      client_payload: { updated_file: output }
    })
  });

  if (res.ok) {
    status.textContent = "✅ File saved and committed to repo!";
  } else {
    status.textContent = "❌ Save failed — check workflow logs.";
  }
};

// 🧩 Helper to get token from local dev storage if running locally
async function getGithubToken() {
  return localStorage.getItem("GH_TOKEN") || "";
}

(async () => {
  await loadCategories();
  await loadData();
})();
</script>
</body>
</html>
